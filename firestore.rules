rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Users: Only own profile ───
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ─── Projects ───
    match /projects/{projectId} {
      // Any authenticated user can create a project
      allow create: if request.auth != null;

      // Only members can read
      allow read: if request.auth != null &&
        request.auth.token.email.lower() in resource.data.memberEmails;

      // Members can update
      allow update: if request.auth != null && (
        // Case 1: Already a member
        request.auth.token.email.lower() in resource.data.memberEmails ||
        // Case 2: Joining via Invitation
        (
          // Verify the invitation token
          get(/databases/$(database)/documents/invitations/$(request.resource.data.lastInviteAccepted)).data.projectId == projectId &&
          get(/databases/$(database)/documents/invitations/$(request.resource.data.lastInviteAccepted)).data.invitedEmail.lower() == request.auth.token.email.lower() &&
          get(/databases/$(database)/documents/invitations/$(request.resource.data.lastInviteAccepted)).data.status == 'accepted'
        )
      );

      // Only owner can delete
      allow delete: if request.auth != null &&
        resource.data.ownerId == request.auth.uid;

      // ─── Transcripts: Members can read/write ───
      match /transcripts/{transcriptId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Codes: Members can read/write (shared codebook) ───
      match /codes/{codeId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── User Data: Members can read all (collaboration), only owner writes ───
      match /userdata/{userId} {
        // All project members can read (needed for collaboration view)
        allow read: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;

        // Only the data owner can write their own data
        allow write: if request.auth != null &&
          request.auth.uid == userId;
      }
      // ─── Sticky Notes: Members can read/write ───
      match /notes/{noteId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Chat: Members can read/write ───
      match /chat/{messageId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Direct Messages: Members can read/write ───
      match /directMessages/{messageId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Code History: Members can read/write ───
      match /codeHistory/{entryId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Change Requests: Members can read/write ───
      match /changeRequests/{requestId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Proposals: Members can read/write ───
      match /proposals/{proposalId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Notifications: Members can read/write ───
      match /notifications/{notificationId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Document Snapshots: Members can read/write ───
      match /documentSnapshots/{snapshotId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }

      // ─── Activity Log: Members can read/write ───
      match /activityLog/{eventId} {
        allow read, write: if request.auth != null &&
          request.auth.token.email.lower() in
          get(/databases/$(database)/documents/projects/$(projectId)).data.memberEmails;
      }
    }

    // ─── Invitations ───
    match /invitations/{invitationId} {
      // Any authenticated user can create an invitation
      allow create: if request.auth != null;

      // Invited user can read their invitations
      allow read: if request.auth != null &&
        request.auth.token.email.lower() == resource.data.invitedEmail;

      // Invited user can update (accept/decline), creator can update
      allow update: if request.auth != null &&
        (request.auth.token.email.lower() == resource.data.invitedEmail ||
         request.auth.uid == resource.data.invitedBy);

      // Creator can delete
      allow delete: if request.auth != null &&
        request.auth.uid == resource.data.invitedBy;
    }
  }
}
